<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Data</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .match-column {
            width: 25%;
        }
        .day-column, .time-column {
            width: 5%;
        }
        .analysis-column {
            width: 5%;
        }
        .confidence-column {
            width: 65%;
        }
        .confidence-container {
            display: flex;
            align-items: center;
        }
        .tip-text {
            flex: 1;
        }
        .confidence-bar {
            width: 50%;
            height: 20px;
            border-radius: 5px;
            position: relative;
            text-align: center;
            color: white;
        }
        .spinner {
            display: none; /* Hidden by default */
            border: 16px solid #f3f3f3; /* Light grey */
            border-top: 16px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin: 0 auto; /* Center the spinner horizontally */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div><button onclick="generateData()">Generate Data</button></div>
    <br></br>
    <div>
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
        <button onclick="fetchAndPopulateMatchData()">Filter</button>
    </div>
    <div class="spinner" id="loadingSpinner"></div>
    <table id="matchTable">
        <thead>
            <tr>
                <th class="match-column">Match</th>
                <th class="day-column">Day</th>
                <th class="time-column">Time</th>
                <th class="time-column">Analysis</th>
                <th class="confidence-column">Tips (Tip | Odds | Source | Confidence)</th>
            </tr>
        </thead>
        <tbody id="matchTableBody">
            <!-- Match data rows will be dynamically added here -->
        </tbody>
    </table>

    <script>
        // Function to fetch match data and populate the table
        function fetchAndPopulateMatchData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let url = '/fetch_match_data';

            if (startDate || endDate) {
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                url += `?${params.toString()}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const matchTableBody = document.getElementById('matchTableBody');
                    matchTableBody.innerHTML = ''; // Clear existing table content

                    data.forEach(match => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="match-column">${match.match}</td>
                            <td class="day-column">${match.match_day}</td>
                            <td class="time-column">${match.match_time}</td>
                            <td class="analysis-column">${match.analysis}</td>
                            <td class="confidence-column">
                            <table>
                                <tbody>
                                    ${match.tips.map(tip => `
                                        <tr>
                                            <td>
                                                <div class="confidence-container">
                                                    <div class="tip-text">${tip.tip}</div>
                                                    <div class="tip-text">${tip.odds}</div>
                                                    <div class="tip-text">${tip.source}</div>
                                                    <div class="confidence-bar" style="background-color: ${calculateColor(tip.confidence)}; width: 50%">
                                                       ${tip.confidence}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            </td>
                        `;
                        matchTableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching match data:', error);
                });
        }

        // Function to calculate color based on confidence value
        function calculateColor(confidence) {
            confidence = Math.max(1, Math.min(3, confidence));
            const t = (confidence - 1) / 2;
            const r = Math.round(255 * (1 - t));
            const g = Math.round(255 * t);
            const b = 0;
            return `rgb(${r}, ${g}, ${b})`;
        }

        function analyseMatchData() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = 'block'; // Show spinner

            fetch('/analyse_data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        fetchAndPopulateMatchData();
                    } else {
                        console.error('Error analysing data:', data.message);
                    }
                })
                .finally(() => {
                    spinner.style.display = 'none'; // Hide spinner
                })
                .catch(error => {
                    console.error('Error analysing data:', error);
                    spinner.style.display = 'none'; // Hide spinner even if there's an error
                });
        }

        // Function to generate data and show/hide the loading spinner
        function generateData() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = 'block'; // Show spinner

            fetch('/generate_data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // launch the analyse, then repopulate table
                        fetchAndPopulateMatchData(); // Repopulate the table
                        //analyseMatchData();
                    } else {
                        console.error('Error generating data:', data.message);
                    }
                })
                .finally(() => {
                    spinner.style.display = 'none'; // Hide spinner
                })
                .catch(error => {
                    console.error('Error generating data:', error);
                    spinner.style.display = 'none'; // Hide spinner even if there's an error
                });
        }

        // Call the function to fetch and populate match data when the page loads
        window.addEventListener('load', fetchAndPopulateMatchData);
    </script>
</body>
</html>
